{% extends "base.html" %}

{% block title %}Database Overview - Maonas Database{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page header -->
    <div class="row">
        <div class="col-12">
            <h1 class="page-header">Database Overview</h1>
            <p class="lead">
                Explore the main tables of the Maonas Database. Use the tabs below to navigate between 
                different data types. Search across all columns and click column headers to sort data.
            </p>
        </div>
    </div>
    
    <!-- Table selection tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="tableTab" role="tablist">
                {% for table_key, table_name in tables.items() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" 
                            id="{{ table_key }}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#{{ table_key }}-content" 
                            type="button" 
                            role="tab"
                            onclick="loadTableData('{{ table_key }}')">
                        {{ table_name }}
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <!-- Tab content -->
    <div class="tab-content mt-3" id="tableTabContent">
        {% for table_key, table_name in tables.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
             id="{{ table_key }}-content" 
             role="tabpanel">
            
            <!-- Table header and search -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <h3 class="section-header">{{ table_name }}</h3>
                </div>
                <div class="col-md-4">
                    <div class="search-container">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="{{ table_key }}-search" 
                                   placeholder="Search all columns in {{ table_name }}...">
                            <button class="btn btn-primary" 
                                    type="button" 
                                    onclick="searchTable('{{ table_key }}')">
                                Search
                            </button>
                            <button class="btn btn-secondary" 
                                    type="button" 
                                    onclick="clearSearch('{{ table_key }}')">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Table statistics and controls -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Records</h5>
                            <h3 class="text-primary" id="{{ table_key }}-total">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Columns</h5>
                            <h3 class="text-info" id="{{ table_key }}-columns">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Current Sort</h5>
                            <p class="mb-0" id="{{ table_key }}-sort-info">None</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <button class="btn btn-success" onclick="exportTable('{{ table_key }}')">
                                Export CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status messages -->
            <div id="{{ table_key }}-status"></div>
            
            <!-- Data table -->
            <div class="table-responsive">
                <div id="{{ table_key }}-loading" class="loading" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
                <table class="table table-striped table-hover" id="{{ table_key }}-table" style="display: none;">
                    <thead>
                        <tr id="{{ table_key }}-headers"></tr>
                    </thead>
                    <tbody id="{{ table_key }}-data"></tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let currentTable = 'imt'; // Default first table
    let tableData = {};
    let currentSort = {}; // Track sorting for each table
    
    // Load initial table data
    document.addEventListener('DOMContentLoaded', function() {
        loadTableData(currentTable);
        
        // Add enter key support for search boxes
        document.querySelectorAll('[id$="-search"]').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchTable(this.id.split('-')[0]);
                }
            });
        });
    });
    
    function loadTableData(tableName, searchTerm = '', sortColumn = '', sortOrder = 'asc') {
        currentTable = tableName;
        
        // Show loading
        document.getElementById(tableName + '-loading').style.display = 'block';
        document.getElementById(tableName + '-table').style.display = 'none';
        document.getElementById(tableName + '-status').innerHTML = '';
        
        // Build URL with parameters
        let url = `/api/table/${tableName}?`;
        const params = new URLSearchParams();
        
        if (searchTerm) {
            params.append('search', searchTerm);
        }
        if (sortColumn) {
            params.append('sort_column', sortColumn);
            params.append('sort_order', sortOrder);
        }
        
        url += params.toString();
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Response length:', text.length);
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.error) {
                        showStatus(tableName, 'error', 'Error: ' + data.error);
                        return;
                    }
                    
                    tableData[tableName] = data;
                    displayTableData(tableName, data);
                    updateTableStats(tableName, data);
                    
                    // Update sort info
                    if (sortColumn) {
                        currentSort[tableName] = {column: sortColumn, order: sortOrder};
                        document.getElementById(tableName + '-sort-info').textContent = 
                            `${formatColumnName(sortColumn)} (${sortOrder.toUpperCase()})`;
                    } else {
                        currentSort[tableName] = null;
                        document.getElementById(tableName + '-sort-info').textContent = 'None';
                    }
                    
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('First 500 chars:', text.substring(0, 500));
                    showStatus(tableName, 'error', 'Invalid JSON response. Check console for details.');
                }
            })
            .catch(error => {
                showStatus(tableName, 'error', 'Network error: ' + error.message);
            })
            .finally(() => {
                document.getElementById(tableName + '-loading').style.display = 'none';
            });
    }
    
    function searchTable(tableName) {
        const searchTerm = document.getElementById(tableName + '-search').value.trim();
        const sort = currentSort[tableName];
        
        loadTableData(tableName, searchTerm, 
                     sort ? sort.column : '', 
                     sort ? sort.order : 'asc');
        
        if (searchTerm) {
            showStatus(tableName, 'info', `Searching all columns for: "${searchTerm}"`);
        }
    }
    
    function clearSearch(tableName) {
        document.getElementById(tableName + '-search').value = '';
        const sort = currentSort[tableName];
        
        loadTableData(tableName, '', 
                     sort ? sort.column : '', 
                     sort ? sort.order : 'asc');
        
        showStatus(tableName, 'info', 'Search cleared');
    }
    
    function sortTable(tableName, column) {
        const currentSortInfo = currentSort[tableName];
        let newOrder = 'asc';
        
        // If clicking the same column, toggle order
        if (currentSortInfo && currentSortInfo.column === column) {
            newOrder = currentSortInfo.order === 'asc' ? 'desc' : 'asc';
        }
        
        const searchTerm = document.getElementById(tableName + '-search').value.trim();
        loadTableData(tableName, searchTerm, column, newOrder);
        
        showStatus(tableName, 'info', `Sorted by ${formatColumnName(column)} (${newOrder.toUpperCase()})`);
    }
    
    function displayTableData(tableName, data) {
        const headersRow = document.getElementById(tableName + '-headers');
        const dataBody = document.getElementById(tableName + '-data');
        
        // Clear existing content
        headersRow.innerHTML = '';
        dataBody.innerHTML = '';
        
        if (data.data.length === 0) {
            showStatus(tableName, 'info', 'No records found.');
            return;
        }
        
        // Create sortable headers
        data.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = formatColumnName(column);
            th.style.cursor = 'pointer';
            th.style.userSelect = 'none';
            th.title = 'Click to sort';
            
            // Add sort indicator if this column is currently sorted
            const currentSortInfo = currentSort[tableName];
            if (currentSortInfo && currentSortInfo.column === column) {
                const indicator = currentSortInfo.order === 'asc' ? ' ▲' : ' ▼';
                th.textContent += indicator;
            }
            
            th.onclick = () => sortTable(tableName, column);
            th.onmouseover = () => th.style.backgroundColor = '#f8f9fa';
            th.onmouseout = () => th.style.backgroundColor = '';
            
            headersRow.appendChild(th);
        });
        
        // Create data rows
        data.data.forEach(row => {
            const tr = document.createElement('tr');
            data.columns.forEach(column => {
                const td = document.createElement('td');
                let value = row[column];
                
                // Format the value for display
                if (value === null || value === undefined) {
                    value = '-';
                } else if (typeof value === 'string' && value.length > 80) {
                    value = value.substring(0, 80) + '...';
                    td.title = row[column]; // Show full text on hover
                }
                
                td.textContent = value;
                tr.appendChild(td);
            });
            dataBody.appendChild(tr);
        });
        
        // Show the table
        document.getElementById(tableName + '-table').style.display = 'table';
        
        if (data.total_records > 0) {
            showStatus(tableName, 'success', `Displaying ${data.total_records} records`);
        }
    }
    
    function updateTableStats(tableName, data) {
        document.getElementById(tableName + '-total').textContent = data.total_records;
        document.getElementById(tableName + '-columns').textContent = data.columns.length;
    }
    
    function formatColumnName(columnName) {
        // Convert database column names to user-friendly names
        const columnMappings = {
            'full_name': 'Full Name',
            'first_name': 'First Name',
            'last_name': 'Last Name',
            'birth_place': 'Birth Place',
            'birth_year': 'Birth Year',
            'death_year': 'Death Year',
            'date': 'Date',
            'type': 'Type',
            'language': 'Language',
            'notary': 'Notary',
            'location': 'Location',
            'value': 'Value',
            'description': 'Description',
            'name': 'Name',
            'origin': 'Origin',
            'construction_date': 'Construction Date',
            'decommission_date': 'Decommission Date',
            'organization_name': 'Organization',
            'founded_year': 'Founded',
            'dissolved_year': 'Dissolved',
            'good_name': 'Good',
            'currency': 'Currency',
            'unit': 'Unit',
            'rate': 'Rate',
            'exchange_rate': 'Exchange Rate',
            'start_date': 'Start Date',
            'end_date': 'End Date',
            'notes': 'Notes',
            'from_currency': 'From Currency',
            'to_currency': 'To Currency',
            'unit_from': 'From Unit',
            'unit_to': 'To Unit',
            'conversion_factor': 'Conversion Factor'
        };
        
        return columnMappings[columnName] || columnName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function showStatus(tableName, type, message) {
        const statusDiv = document.getElementById(tableName + '-status');
        const statusClass = type === 'error' ? 'status-error' : 
                           type === 'success' ? 'status-success' : 'status-info';
        
        statusDiv.innerHTML = `<div class="status-message ${statusClass}">${message}</div>`;
        
        // Auto-hide success and info messages after 5 seconds
        if (type !== 'error') {
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
    }
    
    function exportTable(tableName) {
        const searchTerm = document.getElementById(tableName + '-search').value.trim();
        let url = `/api/table/${tableName}/export`;
        if (searchTerm) {
            url += `?search=${encodeURIComponent(searchTerm)}`;
        }
        
        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = url;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus(tableName, 'success', 'Export started. Download will begin shortly.');
    }
</script>

<style>
/* Additional CSS for sortable headers */
.table th {
    position: relative;
    background-color: #f8f9fa !important;
}

.table th:hover {
    background-color: #e9ecef !important;
}

.status-message {
    padding: 0.75rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
</style>
{% endblock %}